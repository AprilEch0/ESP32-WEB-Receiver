<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Multi ESP32 Dashboard</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;max-width:1000px;margin:24px auto;padding:0 12px}
    .pill{display:inline-block;border:1px solid #ccc;border-radius:999px;padding:2px 10px;font-size:.85rem}
    .ok{color:#1b9e3e}.bad{color:#c0392b}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-top:16px}
    .card{border:1px solid #ddd;border-radius:12px;padding:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
    .tile{border:1px solid #eee;border-radius:10px;padding:10px;text-align:center}
    .k{opacity:.7;font-size:.9rem}.v{font-weight:700;font-size:1.2rem}
    button{padding:6px 10px;margin:2px;border-radius:8px;border:1px solid #ccc;background:#fafafa;cursor:pointer}
  </style>
</head>
<body>
  <h2>Multi ESP32 Dashboard</h2>
  <div>Bağlantı: <span id="conn" class="pill">Bekleniyor…</span></div>
  <div><span class="k">Broker:</span> <code id="broker"></code></div>
  <div><span class="k">Subscribe:</span> <code id="wild"></code></div>

  <div id="devices" class="grid"></div>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    const HOST = "wss://test.mosquitto.org:8081/mqtt";
    const ROOT = "echozero";
    const WILDCARD = `${ROOT}/+/sensors`;
    const CMD_OF = id => `${ROOT}/${id}/cmd`;

    document.getElementById('broker').textContent = HOST;
    document.getElementById('wild').textContent   = WILDCARD;

    const devicesEl = document.getElementById('devices');
    const pill = (cls, txt)=>{ const el=document.getElementById('conn'); el.className='pill '+cls; el.textContent=txt; };

    const cards = new Map();

    function ensureCard(id){
      if (cards.has(id)) return cards.get(id);
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <h3>${id}</h3>
        <small>cmd topic: <code>${CMD_OF(id)}</code></small>
        <div class="row">
          <div class="tile"><div class="k">CO₂</div><div class="v co2">—</div><small>ppm</small></div>
          <div class="tile"><div class="k">TVOC</div><div class="v tvoc">—</div><small>ppb</small></div>
          <div class="tile"><div class="k">Temp</div><div class="v temp">—</div><small>°C</small></div>
          <div class="tile"><div class="k">IP</div><div class="v ip">—</div><small class="ts">ts:—</small></div>
          <div class="tile"><div class="k">LED</div><div class="v led">—</div><small>state</small></div>
        </div>
        <div style="margin-top:8px">
          <button data-cmd="LED_ON">LED Aç</button>
          <button data-cmd="LED_OFF">LED Kapat</button>
          <button data-cmd="TOGGLE">Toggle</button>
          <button data-cmd="PING">Ping</button>
        </div>
      `;
      el.addEventListener('click', e=>{
        if (e.target.tagName!=='BUTTON') return;
        const cmd = e.target.getAttribute('data-cmd');
        client.publish(CMD_OF(id), cmd, {qos:1,retain:false});
        console.log('CMD->',id,cmd);
      });
      devicesEl.appendChild(el);
      cards.set(id, el);
      return el;
    }

    const client = mqtt.connect(HOST, {
      clean:true,
      connectTimeout:8000,
      clientId:'web-'+Math.random().toString(16).slice(2),
    });

    client.on('connect', ()=>{ pill('ok','Bağlandı'); client.subscribe(WILDCARD,{qos:1}); });
    client.on('reconnect',()=> pill('bad','Yeniden bağlanıyor…'));
    client.on('error',()=> pill('bad','Hata'));
    client.on('close',()=> pill('bad','Kapalı'));

    client.on('message',(topic,payload)=>{
      const m = topic.match(/^echozero\/([^/]+)\/sensors$/);
      if (!m) return;
      const id = m[1];
      const card = ensureCard(id);

      try{
        const j = JSON.parse(new TextDecoder().decode(payload));
        const set=(cls,val)=>card.querySelector('.'+cls).textContent=val;
        if (j.co2!=null) set('co2',Math.round(+j.co2));
        if (j.tvoc!=null) set('tvoc',Math.round(+j.tvoc));
        set('temp', j.temp??j.tempC??'—');
        set('ip', j.ip||'—');
        card.querySelector('.ts').textContent='ts: '+(j.ts??'—');
        if (j.led) set('led',j.led);
      }catch(e){console.log(e);}
    });
  </script>
</body>
</html>
