<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Sensors (Multi-Device)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;max-width:980px;margin:24px auto;padding:0 12px}
    .header{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .pill{display:inline-block;border:1px solid #ccc;border-radius:999px;padding:2px 10px;font-size:.85rem}
    .ok{color:#1b9e3e}.bad{color:#c0392b}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:12px}
    .card{border:1px solid #ddd;border-radius:12px;padding:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .tile{border:1px solid #eee;border-radius:10px;padding:10px;text-align:center}
    .k{opacity:.7;font-size:.9rem}.v{font-weight:700;font-size:1.2rem}
    button{padding:6px 10px;border-radius:8px;border:1px solid #ccc;background:#fafafa;cursor:pointer}
    code{background:#f7f7f7;border:1px solid #eee;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="header">
    <h2>Live Sensors (Multi-Device)</h2>
    <div>Bağlantı: <span id="conn" class="pill">Bekleniyor…</span></div>
  </div>
  <div><span class="k">Broker:</span> <code id="broker"></code></div>
  <div><span class="k">Subscribe:</span> <code id="wild"></code></div>

  <div id="devices" class="grid"></div>

  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script>
    // ==== AYARLAR ====
    const HOST = "wss://test.mosquitto.org:8081/mqtt";   // web istemcisi için broker (WSS)
    const ROOT = "echozero";                              // topic kökü
    const WILDCARD = `${ROOT}/+/sensors`;                 // tüm cihazların sensör/heartbeat konusu
    const CMD_OF = id => `${ROOT}/${id}/cmd`;             // o cihaza komut

    document.getElementById('broker').textContent = HOST;
    document.getElementById('wild').textContent   = WILDCARD;

    const $ = s => document.querySelector(s);
    const devicesEl = $('#devices');
    const pill = (cls, txt)=>{ const el = $('#conn'); el.className='pill '+cls; el.textContent=txt; };

    // Cihaz kart havuzu
    const cards = new Map();

    function ensureCard(deviceId){
      if (cards.has(deviceId)) return cards.get(deviceId);
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <b>${deviceId}</b>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <button data-cmd="PING">Ping</button>
            <button data-cmd="LED_ON">LED Aç</button>
            <button data-cmd="LED_OFF">LED Kapat</button>
            <button data-cmd="TOGGLE">Toggle</button>
          </div>
        </div>
        <small>cmd topic: <code>${CMD_OF(deviceId)}</code></small>
        <div class="row" style="margin-top:8px">
          <div class="tile"><div class="k">CO₂</div><div class="v co2">—</div><small>ppm</small></div>
          <div class="tile"><div class="k">TVOC</div><div class="v tvoc">—</div><small>ppb</small></div>
          <div class="tile"><div class="k">Sıcaklık</div><div class="v temp">—</div><small>°C</small></div>
          <div class="tile"><div class="k">IP</div><div class="v ip">—</div><small class="ts">ts: —</small></div>
          <div class="tile"><div class="k">LED</div><div class="v led">—</div><small>state</small></div>
          <div class="tile"><div class="k">Son JSON</div><div class="v last">—</div><small>debug</small></div>
        </div>
      `;
      el.addEventListener('click', (e)=>{
        if (e.target.tagName!=='BUTTON') return;
        const cmd = e.target.getAttribute('data-cmd');
        client.publish(CMD_OF(deviceId), cmd, {qos:1,retain:false});
        console.log('CMD', deviceId, cmd);
      });
      devicesEl.appendChild(el);
      cards.set(deviceId, el);
      return el;
    }

    // MQTT bağlantısı
    const client = mqtt.connect(HOST, {
      clean:true,
      connectTimeout:8000,
      clientId:'web-'+Math.random().toString(16).slice(2),
    });

    client.on('connect', ()=>{
      pill('ok','Bağlandı');
      client.subscribe(WILDCARD, {qos:1});
    });
    client.on('reconnect',()=> pill('bad','Yeniden bağlanıyor…'));
    client.on('error',    ()=> pill('bad','Hata'));
    client.on('close',    ()=> pill('bad','Kapalı'));

    // Mesajları işle
    client.on('message', (topic, payload) => {
      // topic: echozero/<deviceId>/sensors
      const m = topic.match(new RegExp(`^${ROOT}\\/([^/]+)\\/sensors$`));
      if (!m) return;
      const id = m[1];
      const card = ensureCard(id);

      try{
        const txt = new TextDecoder().decode(payload);
        const j = JSON.parse(txt);

        const set = (cls, val)=> card.querySelector('.'+cls).textContent = val;
        if (j.co2  != null) set('co2',  Math.round(+j.co2));
        if (j.tvoc != null) set('tvoc', Math.round(+j.tvoc));
        set('temp', j.temp==null && j.tempC==null ? '—' : Number(j.temp??j.tempC).toFixed(1));
        set('ip',   j.ip || '—');
        card.querySelector('.ts').textContent  = 'ts: ' + (j.ts ?? '—');

        // LED durumu varsa yaz
        if (j.led) set('led', String(j.led));

        // küçük debug: son JSON’un ilk 30 karakteri
        set('last', txt.length > 30 ? txt.slice(0,30)+'…' : txt);
      }catch(e){ console.log(e); }
    });
  </script>
</body>
</html>
